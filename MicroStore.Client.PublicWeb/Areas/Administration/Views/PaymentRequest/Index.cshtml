@using MicroStore.Client.PublicWeb.Areas.Administration.Navigation
@model MicroStore.Client.PublicWeb.Areas.Administration.Models.Billing.PaymentRequestSearchModel
@{
    UIMenuNavigationManager.SetCurrentMenu(BackEndMenusStandard.PaymentRequest.Index);

}
<div>
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-12">
                    <h1 class="m-0">Payments</h1>
                </div>
            </div>
        </div>
    </div>

    <section class="content">
        <div class="container-fluid">
            <partial name="_PaymentRequest.AdvancedSearch" model="Model" />
            <abp-card>
                <abp-card-body>
                    <abp-table id="PaymentRequestsTable"></abp-table>
                </abp-card-body>
            </abp-card>
        </div>
    </section>
</div>


@section Scripts{
    <script>
        $(document).ready(function (){

            $('#StartDate').inputmask('dd/mm/yyyy', { 'placeholder': 'dd/mm/yyyy' })
            $('#EndDate').inputmask('dd/mm/yyyy', { 'placeholder': 'dd/mm/yyyy' })

            var paymentTable = $("#PaymentRequestsTable").DataTable(
                abp.libs.datatables.normalizeConfiguration({
                    ajax: {
                        type: "POST",
                        data: function (data) {
                            data.startDate = $("#StartDate").val();
                            data.endDate = $("#EndDate").val();
                            data.status = $("#Status").val();
                            data.minPrice = $("#MinPrice").val();
                            data.maxPrice = $("#MaxPrice").val();
                            data.orderNumber = $("#OrderNumber").val();
                        }
                    },
                    serverSide: true,
                    processing: true,
                    paging: true,
                    searching: false,
                    ordering: false,

                    columnDefs: [
                        {
                            title: 'Order Number',
                            orderable: false,
                            render : function(data,type,row){
                                const orderNumber=  row.orderNumber;

                                const arr= []

                                for(var i = 0; i <orderNumber.length; i++){
                                    if(i % 3 == 0){
                                        arr.push(orderNumber.substring(i, i + 3))
                                    }
                                }

                                return arr.join(" ")
                            }
                        },
                        {
                            title: "Customer",
                            data: "user",
                            render: function (data, type, row) {
                                return row.user.firstName + " " + row.user.lastName;
                            }
                        },
                        {
                            title: 'Total Cost',
                            data: "totalCost",
                            render: function (data, type, row) {
                                var priceFormat = new Intl.NumberFormat('en-US', {
                                    style: 'currency',
                                    currency: 'USD',
                                })

                                return priceFormat.format(row.totalCost)
                            },
                        },
                        {
                            title: 'Status',
                            data: "status",
                            orderable: false,
                            render: function (data, type, row) {

                                var badgebg;
                                switch (row.status.toLowerCase()) {
                                    case "payed":
                                        badgebg = "bg-success";
                                        break;
                                    case "waiting":
                                        badgebg = "bg-danger";
                                        break;
                                    case "unpayed":
                                        badgebg = "bg-secondary";
                                        break;
                                    default:
                                        badgebg = "bg-danger"
                                        break;

                                }
                                return `<span class='badge ${badgebg}  text-bg-light'>${row.status}</span>`
                            }
                        },
                        {
                            title: 'Created At',
                            render :function(data,type,row){
                                var date = new Date(row.createdAt);
                                return date.toLocaleDateString("en-US",{
                                    minute : "numeric",
                                    hour:"numeric",
                                    day: "numeric",
                                    month:"numeric",
                                    year:"numeric"
                                })
                            }
                        },
                        {
                            orderable: false,
                            title: "Actions",
                            render: function (data, type, row) {
                                return `<a href="PaymentRequest/Details/${row.id}" class="btn btn-info">View</a>`
                            }
                        }
                    ]

                })
            );

            $("#Status").select2();
            $("#AdvancedSearchForm").on('submit', function (evt) {
                evt.preventDefault();
                paymentTable.ajax.reload();
            });
        })
    </script>

}